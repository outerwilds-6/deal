<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è„šæœ¬æ§åˆ¶å°</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background-color: #f4f4f9; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: 220px; background-color: #202b38; color: #ecf0f1; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #34495e; text-align: center; }
        
        .nav-item { padding: 15px 20px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover { background-color: #2c3e50; }
        .nav-item.active { background-color: #34495e; border-left-color: #3498db; }

        /* ä¸»å†…å®¹åŒº */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* å¡ç‰‡å®¹å™¨ */
        .section-container { display: none; } /* é»˜è®¤éšè—æ‰€æœ‰éƒ¨åˆ† */
        .section-container.active { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; animation: fadeIn 0.4s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ ·å¼ */
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; }
        .card h3 { margin-top: 0; color: #2c3e50; }
        .card p { color: #7f8c8d; font-size: 0.95rem; line-height: 1.5; }
        
        /* æŒ‰é’® */
        .btn { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; width: 100%; margin-top: 15px; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* æ§åˆ¶å°è¾“å‡º */
        #console-box { margin-top: auto; background: #1e1e1e; border-radius: 8px; padding: 15px; color: #0f0; font-family: monospace; min-height: 120px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; margin-top: 30px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
    </style>
</head>
<body>

    <!-- å·¦ä¾§å¯¼èˆª -->
    <div class="sidebar">
        <div class="sidebar-header">Script Runner</div>
        <!-- onclick åˆ‡æ¢æ˜¾ç¤ºçš„åŒºåŸŸ -->
        <div class="nav-item active" onclick="switchTab('tab-ai', this)">ğŸ¤– äººå·¥æ™ºèƒ½</div>
        <div class="nav-item" onclick="switchTab('tab-data', this)">ğŸ“Š æ•°æ®å¤„ç†</div>
        <div class="nav-item" onclick="switchTab('tab-utils', this)">ğŸ› ï¸ ç³»ç»Ÿå·¥å…·</div>
    </div>

    <!-- å³ä¾§å†…å®¹ -->
    <div class="main-content">
        
        <!-- 1. äººå·¥æ™ºèƒ½åˆ†ç±» -->
        <div id="tab-ai" class="section-container active">
            
            <!-- äººè„¸è¯†åˆ«å¡ç‰‡ -->
            <div class="card" style="border-top: 4px solid #e74c3c;">
                <h3>äººè„¸è¯†åˆ«å½•å…¥</h3>
                <p>å¯åŠ¨æ‘„åƒå¤´æ•æ‰ç”»é¢ã€‚è¯·åœ¨å¼¹å‡ºçš„çª—å£ä¸­æŒ‰ä¸‹é”®ç›˜ä¸Šçš„ <b>'r'</b> é”®æ¥è®°å½•å½“å‰äººè„¸æ•°æ®ã€‚</p>
                <button class="btn btn-danger" onclick="runScript('face_recognition.py', this, 'è¯·çœ‹æ‘„åƒå¤´çª—å£ï¼ŒæŒ‰ R é”®å½•å…¥...')">å¯åŠ¨è¯†åˆ«ç¨‹åº</button>
            </div>

            <!-- æ–°å¢ï¼šäººè„¸æ¯”å¯¹æ£€æµ‹ -->
            <div class="card" style="border-left: 5px solid #2ecc71;">
                <h3>äººè„¸èº«ä»½æ ¸éªŒ</h3>
                <p>è¯»å–æ•°æ®åº“ (faces.db)ï¼Œæ¯”å¯¹å½“å‰æ‘„åƒå¤´ç”»é¢ä¸­çš„äººè„¸æ˜¯å¦å·²æ³¨å†Œã€‚</p>
                <button class="btn" style="background-color: #2ecc71; color: white;" 
                        onclick="runScript('use_data_to_detect.py', this, 'æ­£åœ¨æ¯”å¯¹äººè„¸ç‰¹å¾...')">
                    å¼€å§‹æ ¸éªŒ
                </button>
            </div>

            <!-- å…¶ä»– AI ç¤ºä¾‹ -->
            <div class="card">
                <h3>å›¾åƒåˆ†ç±» (ç¤ºä¾‹)</h3>
                <p>è°ƒç”¨ PyTorch æ¨¡å‹å¯¹æŒ‡å®šæ–‡ä»¶å¤¹çš„å›¾ç‰‡è¿›è¡Œåˆ†ç±»ã€‚</p>
                <button class="btn btn-primary" onclick="runScript('test.py', this)">è¿è¡Œåˆ†ç±»</button>
            </div>
        </div>

        <!-- 2. æ•°æ®å¤„ç†åˆ†ç±» -->
        <div id="tab-data" class="section-container">
            <div class="card">
                <h3>Excel æ•°æ®æ¸…æ´—</h3>
                <p>è‡ªåŠ¨å¤„ç†æŠ¥è¡¨ä¸­çš„ç©ºç¼ºå€¼å¹¶æ ¼å¼åŒ–æ—¥æœŸã€‚</p>
                <button class="btn btn-primary" onclick="runScript('test.py', this)">å¼€å§‹å¤„ç†</button>
            </div>
        </div>

        <!-- 3. ç³»ç»Ÿå·¥å…·åˆ†ç±» -->
        <div id="tab-utils" class="section-container">
            <div class="card">
                <h3>æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥</h3>
                <p>Ping æµ‹è¯•å†…éƒ¨æœåŠ¡å™¨è¿é€šæ€§ã€‚</p>
                <button class="btn btn-primary" onclick="runScript('test.py', this)">å¼€å§‹æ£€æµ‹</button>
            </div>
        </div>

        <!-- åº•éƒ¨æ§åˆ¶å° -->
        <div id="console-box">ç­‰å¾…æŒ‡ä»¤...</div>
    </div>

    <script>
        // åˆ‡æ¢æ ç›®é€»è¾‘
        function switchTab(tabId, navElement) {
            // 1. éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.section-container').forEach(el => el.classList.remove('active'));
            // 2. æ˜¾ç¤ºé€‰ä¸­çš„åŒºåŸŸ
            document.getElementById(tabId).classList.add('active');
            
            // 3. æ›´æ–°å·¦ä¾§é«˜äº®
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navElement.classList.add('active');
        }

        // è·å– CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // è¿è¡Œè„šæœ¬æ ¸å¿ƒé€»è¾‘
        async function runScript(scriptName, btnElement, customMessage=null) {
            const consoleBox = document.getElementById('console-box');
            
            // UI åé¦ˆ
            const originalText = btnElement.innerText;
            btnElement.disabled = true;
            btnElement.innerText = "è¿è¡Œä¸­...";
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            const startMsg = customMessage ? customMessage : `æ­£åœ¨å¯åŠ¨ ${scriptName}...`;
            consoleBox.innerHTML = `<div class="log-entry" style="color:yellow">>>> ${startMsg}</div>`;

            try {
                const response = await fetch('/api/run/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ script_name: scriptName })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º HTML æ¢è¡Œ
                    consoleBox.innerHTML += `<div class="log-entry">${data.output}</div>`;
                    consoleBox.innerHTML += `<div class="log-entry" style="color:#0f0">>>> æ‰§è¡Œå®Œæ¯•</div>`;
                } else {
                    consoleBox.innerHTML += `<div class="log-entry" style="color:red">>>> é”™è¯¯: ${data.message}</div>`;
                }

            } catch (error) {
                consoleBox.innerHTML += `<div class="log-entry" style="color:red">>>> ç½‘ç»œé”™è¯¯: ${error}</div>`;
            } finally {
                btnElement.disabled = false;
                btnElement.innerText = originalText;
                // æ»šåŠ¨åˆ°åº•éƒ¨
                consoleBox.scrollTop = consoleBox.scrollHeight;
            }
        }
    </script>
</body>
</html>