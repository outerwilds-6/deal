<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è„šæœ¬æ§åˆ¶å°</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background-color: #f4f4f9; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: 220px; background-color: #202b38; color: #ecf0f1; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #34495e; text-align: center; }
        
        .nav-item { padding: 15px 20px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover { background-color: #2c3e50; }
        .nav-item.active { background-color: #34495e; border-left-color: #3498db; }

        /* ä¸»å†…å®¹åŒº */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* å¡ç‰‡å®¹å™¨ */
        .section-container { display: none; } /* é»˜è®¤éšè—æ‰€æœ‰éƒ¨åˆ† */
        .section-container.active { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; animation: fadeIn 0.4s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ ·å¼ */
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; }
        .card h3 { margin-top: 0; color: #2c3e50; }
        .card p { color: #7f8c8d; font-size: 0.95rem; line-height: 1.5; }
        
        /* æŒ‰é’® */
        .btn { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; width: 100%; margin-top: 15px; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* æ§åˆ¶å°è¾“å‡º */
        #console-box { margin-top: auto; background: #1e1e1e; border-radius: 8px; padding: 15px; color: #0f0; font-family: monospace; min-height: 120px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; margin-top: 30px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }

        /* æ—¥å¿—è¡¨æ ¼æ ·å¼ */
        .log-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .log-table th, .log-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .log-table th { background-color: #f2f2f2; color: #333; }
        .log-table tr:nth-child(even) { background-color: #f9f9f9; }
        .log-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .log-img:hover { transform: scale(2.5); transition: 0.2s; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 10; position: relative; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-field { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">Script Runner</div>
        <div class="nav-item active" onclick="switchTab('tab-ai', this)">ğŸ¤– äººè„¸ç³»ç»Ÿ</div>
        <div class="nav-item" onclick="switchTab('tab-logs', this)">ğŸ“œ è¿›é—¨æ—¥å¿—</div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        
        <!-- å…¨å±€åœæ­¢æŒ‰é’® -->
        <div style="margin-bottom: 20px; text-align: right;">
            <button class="btn btn-danger" style="width: auto; background-color: #c0392b;" onclick="stopScript()">
                âš ï¸ å¼ºåˆ¶åœæ­¢æ‰€æœ‰è„šæœ¬
            </button>
        </div>

        <!-- Tab 1: AI ç³»ç»Ÿ -->
        <div id="tab-ai" class="section-container active">
            
            <!-- å½•å…¥å¡ç‰‡ -->
            <div class="card" style="border-top: 4px solid #3498db;">
                <h3>ğŸ‘¤ äººè„¸å½•å…¥</h3>
                <p>è¯·è¾“å…¥ç”¨æˆ·åï¼Œç„¶åç‚¹å‡»å¼€å§‹ã€‚ç³»ç»Ÿå°†è‡ªåŠ¨æŠ“æ‹ä¸€å¼ äººè„¸å¹¶æ³¨å†Œã€‚</p>
                
                <div class="input-group">
                    <input type="text" id="username_input" class="input-field" placeholder="è¾“å…¥å§“å (ä¾‹å¦‚: Wang_Wei)" value="User_01">
                </div>

                <button class="btn btn-primary" onclick="runRegister()">å¼€å§‹å½•å…¥ (è‡ªåŠ¨æŠ“æ‹)</button>
            </div>

            <!-- è¯†åˆ«å¡ç‰‡ -->
            <div class="card" style="border-left: 5px solid #2ecc71;">
                <h3>ğŸ‘ï¸ äººè„¸æ ¸éªŒ</h3>
                <p>å¯åŠ¨æ‘„åƒå¤´è¿›è¡Œäººè„¸è¯†åˆ«ï¼Œå¹¶è®°å½•æ—¥å¿—ã€‚</p>
                <button class="btn" style="background-color: #2ecc71; color: white;" 
                        onclick="runScript('use_data_to_detect.py', [])">
                    å¯åŠ¨é—¨ç¦ç›‘æ§
                </button>
            </div>
        </div>

        <!-- Tab 2: æ—¥å¿—ç³»ç»Ÿ -->
        <div id="tab-logs" class="section-container">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>æœ€è¿‘è¿›é—¨è®°å½•</h3>
                    <button class="btn btn-primary" style="width:auto; padding: 5px 15px;" onclick="loadLogs()">ğŸ”„ åˆ·æ–°</button>
                </div>
                
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æŠ“æ‹</th>
                            <th>å§“å</th>
                            <th>æ—¶é—´</th>
                            <th>ç›¸ä¼¼åº¦</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body">
                        <!-- JS å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="console-box">å‡†å¤‡å°±ç»ª...</div>
    </div>

    <script>
        // åˆ‡æ¢æ ç›®é€»è¾‘
        function switchTab(tabId, navElement) {
            // 1. éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.section-container').forEach(el => el.classList.remove('active'));
            // 2. æ˜¾ç¤ºé€‰ä¸­çš„åŒºåŸŸ
            document.getElementById(tabId).classList.add('active');
            
            // 3. æ›´æ–°å·¦ä¾§é«˜äº®
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navElement.classList.add('active');
        }

        // è·å– CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function switchTab(tabId, navElement) {
             document.querySelectorAll('.section-container').forEach(el => el.classList.remove('active'));
             document.getElementById(tabId).classList.add('active');
             document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
             navElement.classList.add('active');
             if(tabId === 'tab-logs') loadLogs(); // åˆ‡æ¢åˆ°æ—¥å¿—æ—¶è‡ªåŠ¨åˆ·æ–°
        }

        // é€šç”¨è¿è¡Œè„šæœ¬å‡½æ•° (æ”¯æŒä¼ å‚)
        async function runScript(scriptName, args=[]) {
            const consoleBox = document.getElementById('console-box');
            consoleBox.innerHTML = `<div class="log-entry" style="color:yellow">>>> æ­£åœ¨å¯åŠ¨ ${scriptName}...</div>`;

            try {
                await fetch('/api/run/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ script_name: scriptName, args: args })
                });
                consoleBox.innerHTML += `<div class="log-entry">>>> æŒ‡ä»¤å·²å‘é€ï¼Œè¯·æ“ä½œå¼¹å‡ºçš„çª—å£</div>`;
            } catch (error) {
                consoleBox.innerHTML += `<div class="log-entry" style="color:red">>>> é”™è¯¯: ${error}</div>`;
            }
        }

        // ä¸“é—¨çš„å½•å…¥å‡½æ•°
        function runRegister() {
            const name = document.getElementById('username_input').value;
            if (!name) { alert("è¯·è¾“å…¥ç”¨æˆ·åï¼"); return; }
            // è°ƒç”¨è„šæœ¬ï¼Œä¼ å…¥ç”¨æˆ·åä½œä¸ºå‚æ•°
            runScript('face_recognition.py', [name]);
        }

        // åœæ­¢è„šæœ¬
        async function stopScript() {
            const res = await fetch('/api/stop/');
            const data = await res.json();
            document.getElementById('console-box').innerHTML += `<div class="log-entry" style="color:red">>>> ${data.message}</div>`;
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            const tbody = document.getElementById('log-table-body');
            tbody.innerHTML = '<tr><td colspan="5">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const res = await fetch('/api/logs/');
                const json = await res.json();
                
                if (json.status === 'success' && json.data.length > 0) {
                    tbody.innerHTML = '';
                    json.data.forEach(log => {
                        const tr = `
                            <tr>
                                <td>${log.id}</td>
                                <td><img src="${log.img}" class="log-img" onerror="this.src=''"></td>
                                <td><b>${log.user}</b></td>
                                <td>${log.time}</td>
                                <td style="color:${log.sim > 0.5 ? 'green' : 'red'}">${log.sim}</td>
                            </tr>
                        `;
                        tbody.innerHTML += tr;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">æš‚æ— æ•°æ®</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="color:red">åŠ è½½å¤±è´¥: ${e}</td></tr>`;
            }
        }
    </script>
</body>
</html>